<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<title data-react-helmet="true">Deployment Guide | admin-manual</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/admin-manual/docs/deployment/guide"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Deployment Guide | admin-manual"><meta data-react-helmet="true" name="description" content="This document describes the complete deployment of an Agora Voting project"><meta data-react-helmet="true" property="og:description" content="This document describes the complete deployment of an Agora Voting project"><link data-react-helmet="true" rel="shortcut icon" href="/admin-manual/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/admin-manual/docs/deployment/guide"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/admin-manual/docs/deployment/guide" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/admin-manual/docs/deployment/guide" hreflang="x-default"><link rel="stylesheet" href="/admin-manual/assets/css/styles.c36e509a.css">
<link rel="preload" href="/admin-manual/assets/js/runtime~main.73bf6be1.js" as="script">
<link rel="preload" href="/admin-manual/assets/js/main.c8b16299.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/admin-manual/"><img src="/admin-manual/img/nvotes_logo.png" alt="nVotes" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/admin-manual/img/nvotes_logo.png" alt="nVotes" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Admin Manual</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/admin-manual/docs/deployment/guide">Docs</a><a class="navbar__item navbar__link" href="/admin-manual/docs/file-formats/introduction">File Formats</a></div><div class="navbar__items navbar__items--right"><a href="https://nvotes.com/blog/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/agoravoting/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://nvotes.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Powered By nVotes<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Deployment</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/admin-manual/docs/deployment/guide">Deployment Guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/admin-manual/docs/deployment/troubleshooting">Deployment Troubleshooting</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/admin-manual/docs/deployment/browsers-and-cookies">Browsers and Cookies</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Translation</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Election Testing</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Advanced Topics</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Integrations</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Contribute</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1>Deployment Guide</h1></header><p>This document describes the complete deployment of an Agora Voting project
with two Authorities for a production environment in virtual machines.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="requirements"></a>Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">#</a></h2><p>You need 4 Linux x64 host machines with at least 4GB of RAM each and a clean
Ubuntu 20.04 LTS installed and around 30GB of HD.</p><p>The structure of the four machines is:</p><ul><li><p>prod-s1
used as master web server</p></li><li><p>prod-s2
used as slave web server</p></li><li><p>prod-a1
used as election authority 1</p></li><li><p>prod-a2
used as election authority 2</p></li></ul><p>The instructions in the requirements section should be executed in all 4
machines. We asume that either:</p><p>a. A fith machine can be used as the load balancer and for high availability
purposes and act as the public interface to the Internet. This is not a
requirement, you can just point the DNS to the master and change it manually
if it fails, but then only the master will be serving requests. The load
balancer can be provided by the cloud provided if you use one. We do not have
any ansible deployment script to configure the load balancer.</p><p>b. Otherwise, prod-s1 will be used as the public interface interface to the
Internet unless it fails, then prod-s2 will be used for continuing operations.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="ops-environment"></a>Ops environment<a class="hash-link" href="#ops-environment" title="Direct link to heading">#</a></h2><p>It’s recommended to minimize the number of publicly reachable machines to
minimize attack surface. That’s why other than the publicly serving machines like load
balances and such, all the communications should be done through an internal
network unreachable through the Internet.</p><p>To reach to this internal network, we suggest to use an <code>ops</code> machine as a
single point of access for increased security and simplicity. For example, in
our case as we usually use Amazon Web Services EC2, our <code>ops</code> machine is called
<code>aws-ops</code>. This machine allows us to access all the other ones via ssh.</p><p>If you are using vagrant for local development, your <code>ops</code> machine might just
be the physical host.</p><p>WARNING: Currently the vagrant configuration is outdated and needs changes to
work.</p><p>Some other recommendations to minimize attack surface:</p><ul><li>Use wisely security groups: only open ports to the Internet if you really
need to.</li><li>Do not setup a public ip address to a machine if it can keep being private.
All machines should only be accessible through ssh via the <code>ops</code> machine,
with the root@aws-ops user and to the root user of the destination machine.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="configuring-access-to-each-vm-inside-the-ops-machine"></a>Configuring access to each VM inside the ops machine<a class="hash-link" href="#configuring-access-to-each-vm-inside-the-ops-machine" title="Direct link to heading">#</a></h3><p>Each machine should have its own static private ip address inside the private
network and its own name. This should be configured in the <code>ops</code> machine to
access them by name.</p><p>By default, ssh access to this deployment machines is done through the <code>ubuntu</code>
user, and only from that you can <code>sudo -s</code> to root or other users. In order for
not to need to specify this user everytime you login and for every new machine,
we suggest you add the following two lines to the <code>/root/.ssh/config</code> file:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Host *</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">User ubuntu</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="configuring-ops-hosts"></a>Configuring ops hosts<a class="hash-link" href="#configuring-ops-hosts" title="Direct link to heading">#</a></h3><p>For each machine, you will need to add a line in <code>/etc/hosts</code> in the <code>ops</code>
machine, for example  <code>192.168.1.2 prod-s1</code>.</p><p>In case of using vagrant for local deployment, this won&#x27;t be needed as it&#x27;s
already configured by vagrant.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="collaborate-sharing-with-tmuxinator"></a>Collaborate sharing with tmuxinator<a class="hash-link" href="#collaborate-sharing-with-tmuxinator" title="Direct link to heading">#</a></h3><p>To help collaboration during operations among employees and to ease operations
and monitorization of a deployment, we recommend to execute everything under a
single shared <code>tmux</code> session per deployment in the <code>ops</code> machine. </p><p>We use <code>tmuxinator</code> to help managing these <code>tmux</code> sessions. Please install it
in the <code>ops</code> machine in the root user.</p><p>You can access our base skeleton configuration for a deployment in the
<a target="_blank" href="/admin-manual/assets/files/deployment-skel-cc75d97a27c7c6e3e294b46abcea2d64.yml">deployment-skel.yml</a> file. You can:</p><ol><li>Install <code>tmux</code> and <code>tmuxinator</code> in the <code>ops</code> machine:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">apt</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> tmux tmuxinator -y</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="2"><li>Add an <code>mux</code> alias to your <code>/root/.bashrc</code>: </li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;alias mux=&#x27;tmuxinator&#x27;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;&gt;</span><span class="token plain"> /root/.bashrc</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="3"><li><p>Create the base tmuxinator config file that you&#x27;ll copy for each deployment
by copying the file <a target="_blank" href="/admin-manual/assets/files/deployment-skel-cc75d97a27c7c6e3e294b46abcea2d64.yml">deployment-skel.yml</a> into the
file <code>/root/.tmuxinator/deployment-skel.yml</code> of the <code>ops</code> machine, and also the
file <a target="_blank" href="/admin-manual/assets/files/tmux.conf-1ea944c595a2e9828fd022867ac9a3ce.yml">.tmux.conf</a> into <code>/root/.tmux.conf</code> of the <code>ops</code>
machine.</p></li><li><p>Learn the basic tmuxinator &amp; tmux commands:</p></li></ol><ul><li><code>mux list</code>: List the available projects</li><li><code>mux copy deployment-skel prod</code>: Copy the deployment-skel to create a <code>prod</code>
project. This commands directly enters into your configured editor, to edit
the project before creating it. If you are using the base skel we mentioned
earlier and you are using vim as the editor, you can easily just do a quick
find &amp; replace all with the command: <code>:%s/BASE/prod/g</code> or similar.</li><li><code>mux prod</code>: Attaches to the <code>prod</code> project session, starting it first if it
wasn&#x27;t started.</li><li><code>mux del prod</code>: Removes the prod project.</li><li><code>mux stop prod</code>: Stops the prod project session.</li><li>Ctrl+a, d: Once in a session, detaches from this session.</li><li>Ctrl+a, c: Adds a new tab terminal to the current session.</li><li>Ctrl+Left/Right arrow: moves from one tab terminal to the other.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="creating-the-mux-project"></a>Creating the mux project<a class="hash-link" href="#creating-the-mux-project" title="Direct link to heading">#</a></h3><p>Each deployment is compromised of multiple machines. As mentioned earlier, we
recommend to create a tmuxinator project for each deployment.</p><p>Use <code>mux copy deployment-skel &lt;deployment-name&gt;</code>: Copy the deployment-skel to
create a <code>&lt;deployment-name&gt;</code> project. Do a quick find &amp; replace all in vim
inside the file with the command: <code>:%s/BASE/&lt;deployment-name&gt;/g</code> then save and
exit with <code>:wq</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="for-each-machine"></a>For each machine<a class="hash-link" href="#for-each-machine" title="Direct link to heading">#</a></h2><p>Refer to this section for the configuration steps you need to take into account
and execute for each of the machines in the deployment (agora master, slave,
auth1, auth2..).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="machine-provisioning"></a>Machine provisioning<a class="hash-link" href="#machine-provisioning" title="Direct link to heading">#</a></h3><p>As mentioned earlier, you should provision each VM with Ubuntu 16.04 LTS,
4GB of RAM and usually around 30GB HD. The machine requirements might
vary depending on the size and number of the elections that these machines will
be used for.</p><p>For a faster deployment we recommend to increase the number of cores. This can
be reduced later to even just 1 core and 2GB of RAM.</p><p>In AWS EC2 we usually use the free <code>Ubuntu 20.04 LTS - Focal</code> AWS Marketplace
AMI provided by <code>Canonical Group Limited</code>. If you are using vagrant, it will
take care of the provisioning of the VMs.</p><p>It&#x27;s customary for us to name each machine by the hostname it will use. For
example in AWS EC2 an instance whose hostname is <code>prod-a1</code> (trustee #1 for the
production deployment) would be called <code>prod-a1</code>. Also, the name of the related
volume (the hard disk) would have the same name.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="machine-configuration"></a>Machine configuration<a class="hash-link" href="#machine-configuration" title="Direct link to heading">#</a></h3><p>Once the machines are provisioned, we should configure them individually. The
ansible deployment script is typically executed within the deployed machine.
This allows us to have different deployments with different ansible versions
all reachable through the <code>ops</code> machine.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="network-firewall--dns"></a>Network, firewall &amp; DNS<a class="hash-link" href="#network-firewall--dns" title="Direct link to heading">#</a></h3><p>We use static private (and public) ip addresses. All the machines in the
deployment should be able to see each other and be reachable via the <code>ops</code>
machine.</p><p>To do that, for example in AWS we assign a security group called <code>internal</code>
that has the following rule:</p><ul><li>Type: All traffic</li><li>Protocol: All</li><li>Port range: All</li><li>Source: 172.31.0.0/16</li></ul><p>Firewall rules should be created to allow the following kind of connections:</p><ul><li><strong>postgresql:</strong> prod-s1 <strong>&lt;&lt;tcp:5432&gt;&gt;</strong> prod-s2</li><li><strong>postgresql&#x27;s rsync:</strong> prod-s1 <strong>&lt;&lt;tcp:22&gt;&gt;</strong> prod-s2</li><li><strong>memcached:</strong> prod-s1 <strong>&lt;&lt;udp:11211&gt;&gt;</strong> prod-s2</li><li><strong>web site:</strong> [prod-s1, prod-s2] <strong>&lt;&lt;tcp:443&gt;&gt;</strong> Internet</li><li><strong>sentry api:</strong> [prod-s1, prod-s2] <strong>&lt;&lt;tcp:9090&gt;&gt;</strong> Internet</li><li><strong>sentry web site:</strong> [prod-s1, prod-s2] <strong>&lt;&lt;tcp:8443&gt;&gt;</strong> Internet</li><li><strong>eotest:</strong> prod-a1 <strong>&lt;&lt;tcp:5000&gt;&gt;</strong> prod-a2</li><li><strong>mixnet:</strong> prod-a1 <strong>&lt;&lt;tcp:4081&gt;&gt;</strong> prod-a2</li><li><strong>mixnet:</strong> prod-a1 <strong>&lt;&lt;udp:8081&gt;&gt;</strong> prod-a2</li><li><strong>private ballots download:</strong> [prod-s1, prod-s2] <strong>&lt;&lt;tcp:14453&gt;&gt;</strong> [prod-a1, prod-a2]</li></ul><p>You can create the appropiate rules to allow this access to the different
services. For example if one or more of the trustee machines are external,
you will have to open the appropiate ports so that they can communicate with
the <code>prod-s1</code> and <code>prod-s2</code> machines and with the trustee machines in the
internal network.</p><p>We also typically configure the public access to the servers through cloudflare.
To make it work, you need to give public access to the 80,443 and 8443 ports
to <a href="https://www.cloudflare.com/ips/" target="_blank" rel="noopener noreferrer">cloudflare ips</a>. In AWS we use a
<code>cloudflare</code> security group for that and apply it either to the master machine
(<code>prod-s1</code>) or to the load balancer, and then assign a Public Static IP
address for that machine and point to that IP Address in Cloudflare&#x27;s DNS.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="backups"></a>Backups<a class="hash-link" href="#backups" title="Direct link to heading">#</a></h3><p>In AWS EC2 we use <code>AWS Backup</code> to automate backups. They are done at the VM
level and they can be easily created by simply assigning a tag to the Volumnes
of the VMs.</p><p>AWS Backup creates and manages (also deleting old ones) snapshots of volumes.
BTW we usually configure the instances to be encrypted, and thus snasphots are
also encrypted. </p><p>We usually have a backup plan in <code>AWS Backup</code> that is applied to any volume
with the <code>backup-normal</code> tag, with the following configuration:</p><ul><li>1 daily backup, save 6 last.</li><li>1 weekly backup, save 4 last.</li><li>1 monthly backup, save 24 last.</li><li>1 each 3 hours, save 7 last.</li></ul><p>To restore a backup, you just need to create a volume out of this snapshot in
the same Availability Zone as the instance you want to attach it to. </p><p>We usually do that manually with a name similar to the original volume name, for
example it could be <code>prod-a1-restored-1</code>. You could stop the <code>prod-a1</code> instance,
detach the <code>prod-a1</code> volume, attach the new <code>prod-a1-restored-1</code> volume as
<code>/dev/sda1</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="non-root-permissions-optional"></a>Non-root permissions (optional)<a class="hash-link" href="#non-root-permissions-optional" title="Direct link to heading">#</a></h3><p>One can use a non-root use for deployment. Unless a requirement, we don&#x27;t
usually do it. Thus, this step is not very well tested lately. Deployment is
typically done within the Ubuntu machine as the root user. You can skip this
step.</p><p>To configure non-root permissions in the VM, first create the deployment user<br>
if it hasn&#x27;t been created yet. We&#x27;ll use <strong>agora</strong> for that:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1 # adduser agora agora --gecos &quot;FullName,RoomNumber,WorkPhone,HomePhone&quot; --disabled-password</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Afterwards, you should add the permissions that the agora user requires for
administration and deployment.</p><p>This is how you do it in the two servers that will be used as authorities:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1 # wget https://raw.githubusercontent.com/agoravoting/agora-dev-box/next/doc/production/auth.sudoers</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1 # cat auth.sudoers &gt;&gt; /etc/sudoers</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And this is how you do it for the two other servers that will be used as master
and slave machines:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1 # wget https://raw.githubusercontent.com/agoravoting/agora-dev-box/next/doc/production/agora.sudoers</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1 # cat agora.sudoers &gt;&gt; /etc/sudoers</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="timezones-details"></a>Timezones details<a class="hash-link" href="#timezones-details" title="Direct link to heading">#</a></h3><p>Once deployed, the server will be configured to use UTC timezone. This is
automatically done by the ansible deployment scripts. This is considered a
<a href="http://yellerapp.com/posts/2015-01-12-the-worst-server-setup-you-can-make.html" target="_blank" rel="noopener noreferrer">good practice</a>,
and is performed by the ansible deployment scripts by executing the following
commands automatically:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">ln</span><span class="token plain"> -sf /usr/share/zoneinfo/UTC /etc/localtime</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">dpkg-reconfigure -f noninteractive tzdata</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Server logs, therefore, will all be in UTC.</p><p>Any date and time you input in your data will be in UTC timezone. You can
configure the output timezone and date format of the election results PDFs using
the
<a href="/admin-manual/docs/file-formats/election-creation-json#pipe-configure_pdf">configure_pdf pipe</a>.
See <a href="/admin-manual/docs/file-formats/election-creation-json#results-config-pipes">Results Config Pipes</a>
for more information about how this works.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="install-and-configure-deployment-dependencies"></a>Install and configure deployment dependencies<a class="hash-link" href="#install-and-configure-deployment-dependencies" title="Direct link to heading">#</a></h3><p>Within the provisioned machine (for example <code>prod-s1</code>), there are a series of
steps required for a  proper and successful deployment. We will from now on
assume we are using the root user (<code>sudo -s</code>) inside the provisioned VM to
execute all the tasks.</p><p>We will first install some dependencies and reboot:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;source /usr/share/virtualenvwrapper/virtualenvwrapper.sh&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;&gt;</span><span class="token plain"> /root/.bashrc</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">apt-get</span><span class="token plain"> update </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">apt-get</span><span class="token plain"> dist-upgrade -y </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">apt</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> virtualenvwrapper -y  </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">reboot</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We usually have a copy of the configuration file in <code>ops</code> then copy it to the
machine (we cannot directly ssh to it for security reasons). So we usually have
a generic config file in ops machine. Then from ops, copy it to the provisioned
machine, for example in prod-s1:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">scp</span><span class="token plain"> config-base.yml prod-s1:/home/ubuntu/config.yml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The previous step is not really required, but it is required for the following
steps to have the <code>config.yml</code> inside the <code>/home/ubuntu</code>. You can for example
use the config file from <a target="_blank" href="/admin-manual/assets/files/config.master-ede905194e3e7f52840b8fe6bc305d9a.yml">config.master.yml</a> as a
base, copying it instead.</p><p>Then in the provisioned machine as root, we install dependencies and move the
config file where it needs to be (for example <code>/root/prod-s1/root.yml</code>):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># change the NAME var to the appropiate name</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">NAME</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;prod-s1&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:rgb(130, 170, 255)">LC_ALL</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;en_US.UTF-8&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">LC_CTYPE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;en_US.UTF-8&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mkvirtualenv ansible -p </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">which</span><span class="token variable" style="color:rgb(191, 199, 213)"> python3</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">deactivate</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">workon ansible</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># should return Python 3.8.5:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">python --version </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> /root</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> clone https://github.com/agoravoting/agora-dev-box.git </span><span class="token variable" style="color:rgb(191, 199, 213)">$NAME</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$NAME</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> checkout master</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># needed for ansible. If you are deploying an election authority use</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># doc/production/playbook.auth.yml instead</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;localhost ansible_connection=local&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> inventory </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> doc/production/playbook.agora.yml playbook.yml</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># copy the config file to /root/$NAME/root.yml</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> /home/ubuntu/config.yml config.yml</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># update and set random passwords. NOTE: Do not do that for the slave machines, </span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># it needs to be using the same passwords as the master.</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">DATE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">date</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> config.yml </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;config_base_</span><span class="token string variable" style="color:rgb(191, 199, 213)">$DATE</span><span class="token string" style="color:rgb(195, 232, 141)">.yml&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> python3 helper-tools/manage_config_pwd.py -c </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;config_base_</span><span class="token string variable" style="color:rgb(191, 199, 213)">$DATE</span><span class="token string" style="color:rgb(195, 232, 141)">.yml&quot;</span><span class="token plain"> -l </span><span class="token number" style="color:rgb(247, 140, 108)">40</span><span class="token plain"> -o config.yml</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pip </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">ansible</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token number" style="color:rgb(247, 140, 108)">2.9</span><span class="token plain">.18</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After this, one should edit the config.yml file and edit the appropiate values,
please read below about how to do that. </p><p>For the slave machine (for example <code>prod-s2</code>) one would copy the config.yml
from <code>prod-s1</code> and not change the the passwords with the <code>manage_config_pwd.py</code>
script. </p><p>Even for the election authorities&#x27; machines, it&#x27;s easiest to just copy the
<code>config.yml</code> file from <code>prod-s1</code> and use it as a base. However, we provide
sample production config files for both agora and auth machines in the
<code>doc/production</code> directory.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="web-servers-master--slave-deployment"></a>Web servers master &amp; slave deployment<a class="hash-link" href="#web-servers-master--slave-deployment" title="Direct link to heading">#</a></h2><p>Both machines prod-s1 and prod-s2 should be setup with the same passwords,
because they will be a replica of each other: the slave will be in hot standby
configuration. The only difference between the configuration file of <code>pro-s1</code>
and <code>prod-s2</code> should be the following config keys:</p><ul><li>config.hostname</li><li>config.public_ipaddress</li><li>config.private_ipaddress</li><li>config.load_balancing.repmgr_node_id</li></ul><p>Please read the comments and instructions inside the configuration file
and accordingly. Both machines for deploy purposes should have the
<strong>config.load_balancing.is_master</strong> set to <strong>true</strong> and The
<strong>config.load_balancing.master.slave_postgres_ssh_keys</strong> and
<strong>config.load_balancing.master.slave_agoraelections_ssh_keys</strong> set to <strong>[]</strong>
(which means empty list) at this stage of deployment.</p><p>If your machine is behind a proxy, you need to specify that in the
<strong>config.has_https_proxy</strong> variable.</p><p>After setting the configuration, you should set the playbook that we will use
for deploying as master the machines, we already configured the inventory for
deploying locally. The next step is to deploy with ansible:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">time</span><span class="token plain"> ansible-playbook -i inventory playbook.yml</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">date</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Once this is done, the initial as-master deployment has been successful.</p><p>If you have assigned a FQDN to for example &#x27;agora.example.com&#x27; to the machine
and the name resolution is set up correctly in your personal machine via DNS or
by adding &#x27;agora.example.com ipaddr&#x27; to your &#x27;/etc/hosts&#x27;, you should be able to login
as an administrator entering in &#x27;<a href="https://agora.example.com/admin/login&#x27;" target="_blank" rel="noopener noreferrer">https://agora.example.com/admin/login&#x27;</a> using
the credentials you specified in the config.yml file.</p><p>We recommend to use the /etc/hosts file to change the ip address of the
webserver from prod-s1 to prod-s2 ip easily for testing purposes.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="configure-the-slave"></a>Configure the slave<a class="hash-link" href="#configure-the-slave" title="Direct link to heading">#</a></h3><p>To configure prod-s2 as a slave, we need to import the ssh keys from the
agoraelections and postgres users in <em><code>prod-s1</code></em> to add them in *<code>prod-s2</code>.</p><p>To get the keys execute these commands in <em><code>prod-s2</code></em>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> -u agoraelections </span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> /home/agoraelections/.ssh/id_rsa.pub</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> -u postgres </span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> /var/lib/postgresql/.ssh/id_rsa.pub</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Copy those keys and set them in the <code>prod-s1</code> <strong>config.yml</strong> file in
the variables <strong>config.load_balancing.master.slave_agoraelections_ssh_keys</strong>
and <strong>config.load_balancing.master.slave_postgres_ssh_keys</strong>.</p><p>Then, execute again ansible in <em><code>prod-s1</code></em> to apply the changes:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">time</span><span class="token plain"> ansible-playbook -i inventory playbook.yml</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">date</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After that, then you can change the <strong>config.yml</strong> for <code>prod-s2</code> to set
the variable <strong>config.load_balancing.is_master</strong> to <strong>false</strong>,
<strong>config.load_balancing.slave.master_hostname</strong> to the hostname of <code>prod-s1</code>
and <strong>config.load_balancing.repmgr_node_id</strong> to <strong>2</strong>.</p><p>If your machine is behind a proxy, you need to specify that in the
<strong>config.has_https_proxy</strong> variable.</p><p>Then you can run again ansible in <code>prod-s2</code> to apply the changes, using the
slave specific playbook, which can only work after having executed
<strong>playbook.agora.yml</strong>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s2:/root/prod-s2/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> doc/production/playbook.slave.yml playbook.yml</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s2:/root/prod-s2/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">time</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> ansible-playbook -i inventory playbook.yml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>See the <a href="#high-availability-and-load-balancing-halb">High availability and load balancing (HA/LB)</a>
section to see more information about how to check if everything is working
and how to promote the slave to be master and also change it back to be a slave.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="deployment-of-authorities"></a>Deployment of authorities<a class="hash-link" href="#deployment-of-authorities" title="Direct link to heading">#</a></h2><p>Please follow the steps of the <a href="#for-each-machine">For Each Machine section</a> to
do the initial provisioning and configuration of the election authorities,
prod-a1, prod-a2. Afterwards, continue reading this section.</p><p>We&#x27;ll use an authority config file as a base:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> doc/production/config.auth.yml config.yml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Edit the config.yml file following the instructions inside. Specifically, don&#x27;t forget to edit:</p><ul><li>config.hostname</li><li>config.public_ipaddress</li><li>config.private_ipaddress</li><li>config.hosts</li></ul><p>In particular, you need to ensure that the FQDN points to the private network
IP Address of the master machine using config.hosts, using a configuration
similar to:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">hostname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> demo.example.com</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 192.168.50.14 </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># this should be the ip of the new master</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note that the above is required only if the authority is in a private network
and cannot reach to this web server using the public ip address.</p><p>Then deploy as usual:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">time</span><span class="token plain"> ansible-playbook -i inventory playbook.yml</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">date</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="connecting-authorities"></a>Connecting authorities<a class="hash-link" href="#connecting-authorities" title="Direct link to heading">#</a></h3><p>Authorities communicate with other authorities using ssl and client
certificates so the authority server doesn&#x27;t accept queries from unknown
servers. In a real election system it&#x27;s a good idea to not publish the ips
and ports of the authorities to avoid malicious attacks.</p><p>The deployment script creates a certificate for each authority in
/srv/cert/selfsigned/ and we manage the authority communication and
certificate sharing with the eopeers tool.</p><p>Execute the following in <code>prod-a1</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ eopeers --show-mine</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Copy the output to a file in <code>prod-a2</code>, then install it:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a2:/root/prod-a2/ $ eopeers --install prod-a1.pkg</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a2:/root/prod-a2/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">service</span><span class="token plain"> nginx restart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Then do the same the other way around:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ eopeers --show-mine</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ eopeers --install prod-a2.pkg</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">service</span><span class="token plain"> nginx restart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="test-the-connection-between-the-authorities"></a>Test the connection between the authorities<a class="hash-link" href="#test-the-connection-between-the-authorities" title="Direct link to heading">#</a></h3><p>A tool is installed to test the real connection between the authorities.
Open two terminal windows.  Open <code>eolog</code> in one of the terminal windows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> eolog</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Run eotest in the other terminal window from the other auth server:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ eotest full --vmnd --vcount </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token plain"> --peers prod-a2</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You should see the software working as eolog output will appear in the
first terminal window. Once it the eotest command finishes, you can also close
prod-a2 connection to eolog. Congratulations, you have run a complete test
between the two authorities in which:</p><ol><li><strong>Create:</strong> Election public and private keys have been created.</li><li><strong>Encrypt:</strong> Test ballots have been created and encrypted.</li><li><strong>Tally:</strong> Those encrypted votes have been mixed and decrypted.</li></ol><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>The <code>eotest</code> command is useful to test election authorities. You can change the
number of votes to use in the test using the <code>--vcount</code>  option. In our example
above we used 100 votes, but you could tally 100,000 or any other number. This
can help you find out how much time the tally would take and if the authority
machine configuration and hardware would work with a specific number of votes.</p><p>By default eotest uses all connected authorities, but you can also specify with
which other authorities you want to do the test using the <code>--peers</code> option.
You can execute each of the steps individually using <code>create</code>, <code>encrypt</code> or
<code>tally</code> options instead of <code>full</code>. Find more information with <code>eotest --help</code>.</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="connecting-web-servers-with-authorities"></a>Connecting web servers with authorities<a class="hash-link" href="#connecting-web-servers-with-authorities" title="Direct link to heading">#</a></h3><p>The following commands should be executed in both <code>prod-s1</code> and <code>prod-s2</code>
machines:</p><p>Create <strong>prod-a1.pkg</strong> and <strong>prod-a2.pkg</strong> files with the configuration of both
authorities. Then install them:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1:/root/prod-s1/ $ eopeers --install prod-a1.pkg --keystore /home/agoraelections/keystore.jks</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1:/root/prod-s1/ $ eopeers --install prod-a2.pkg</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1:/root/prod-s1/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">service</span><span class="token plain"> nginx restart</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1:/root/prod-s1/ $ supervisorctl restart agora-elections</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Please note that there&#x27;s a difference between the first two eopeers commands.
The first one is configured to be executed to add the key to agora-elections
keystore for the director authority <code>prod-a1</code>. Afterwards, we need to restart
not only <code>nginx</code> but also <code>agora-elections</code> precisely because this service needs
to reload the `<code>prod-a1</code> TLS certificate keys.</p><p>Before completion, the installation of the certificate of the <code>prod-s1</code> and
<code>prod-s2</code> servers needs to be installed in the election authorities, because
even though i&#x27;ts the same TLS cert, they have different hostnames. So copy
them (get it with &quot;eopeers --show-mine&quot;) to the authorities and install them:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ eopeers --install prod-s1.pkg</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ eopeers --install prod-s2.pkg</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-a1:/root/prod-a1/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">service</span><span class="token plain"> nginx restart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="create-a-test-election"></a>Create a test election<a class="hash-link" href="#create-a-test-election" title="Direct link to heading">#</a></h2><p>Go to https://prod-s1/admin/login and create a test election. Then execute
the following to create some votes. Change &#x27;2&#x27; in the following commands with
your election number:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1:/root/prod-s1/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">su</span><span class="token plain"> - agoraelections</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~ $ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">source</span><span class="token plain"> ~/env/bin/activate</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~ $ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> ~/agora-elections/admin</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~ $ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">ELECTION_ID</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~/agora-elections/admin/ $ ./admin.py dump_pks </span><span class="token variable" style="color:rgb(191, 199, 213)">$ELECTION_ID</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~/agora-elections/admin/ $ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;[1,0]&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> votes.json</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~/agora-elections/admin/ $ ./admin.py encrypt </span><span class="token variable" style="color:rgb(191, 199, 213)">$ELECTION_ID</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>start the election, cast the votes, stop it and tally it:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~/agora-elections/admin/ $ ./admin.py start </span><span class="token variable" style="color:rgb(191, 199, 213)">$ELECTION_ID</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~/agora-elections/admin/ $ ./admin.py cast_votes </span><span class="token variable" style="color:rgb(191, 199, 213)">$ELECTION_ID</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~/agora-elections/admin/ $ ./admin.py count_votes </span><span class="token variable" style="color:rgb(191, 199, 213)">$ELECTION_ID</span><span class="token plain"> </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># it will output: &quot;2 (2)&quot; which means 2 votes cast, 2 unique voters</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~/agora-elections/admin/ $ ./admin.py stop </span><span class="token variable" style="color:rgb(191, 199, 213)">$ELECTION_ID</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agoraelections@prod-s1:~/agora-elections/admin/ $ ./admin.py tally </span><span class="token variable" style="color:rgb(191, 199, 213)">$ELECTION_ID</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="high-availability-and-load-balancing-halb"></a>High availability and load balancing (HA/LB)<a class="hash-link" href="#high-availability-and-load-balancing-halb" title="Direct link to heading">#</a></h2><p>nVotes platform can be configured to support both load balancing and high
availability, using a master-slaves configuration.</p><p>High availability means that the slaves contain a replica of the master, so in
the event of the master machine failing, one of the slaves can take over by
being promoted to master. This is a process that currently have to be executed
manually following the steps in the
<a href="#promoting-a-slave-to-be-master">Promoting a slave to be master</a> section.</p><p>Load balancing allows to partially scale horizontally, allowing to serve more
http requests per second. nVotes platform allows to perform load balancing only
in the web servers (<code>prod-s1</code>, <code>prod-s2</code>, etc) but not in the election authority
servers (<code>prod-a1</code>, <code>prod-a2</code>, etc). For scaling election authorities, currently
the only way to do it is either subdividing an electoral process in multiple
elections with different election authority servers, or scaling vertically the
election authorities by adding more CPU/RAM/Disk resources to these machines.</p><p>The way nVotes deploys the master and the slave means that the master
(<code>prod-s1</code> in this guide) has the readwrite instance of the PostgreSQL database
and the slaves (<code>prod-s2</code>) have only a read-only database replica.</p><p>However, other than that, all the backend services are replicated in both master
and slaves machines (<code>authapi</code>, <code>authapi_celery</code>, <code>agora-elections</code> and <code>nginx</code>).
<code>agora-elections</code> uses <code>memcached</code> to cache queries and improve performance, and
all slaves connect directly to the <code>memcached</code> instance of the master machine.</p><p>On the other hand, there are currently some limitations on the load balancing:
<code>authapi</code>, <code>authapi_celery</code> and <code>agora-elections</code> connect directly to the master
PostgreSQL instance, and no load balancing is performed in the database level,
only at the application level.</p><p>Finally, <code>authapi_celery</code> uses <code>RabbitMQ</code> as its broker to manage messages and
queues. Each server, independing of it being a master or a slave, currently
runs its own <code>RabbitMQ</code> queue. That means that a task to send an SMS message
scheduled by <code>prod-s1</code> will only be run by <code>prod-s1</code>, and same for any other
server (for example <code>prod-s2</code>).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="checking-the-cluster"></a>Checking the cluster<a class="hash-link" href="#checking-the-cluster" title="Direct link to heading">#</a></h3><p>The master/slave configuration in this configuration basically means that:</p><ol><li><code>prod-s2</code> is a server that is replicating in a hot standby mode the database
of <code>prod-s1</code>. </li><li><code>prod-s2</code> has also replicated everything needed to be able to change the
server from slave to master at any time.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="checking-that-the-slave-works-using-a-load-balancer"></a>Checking that the slave works using a Load Balancer<a class="hash-link" href="#checking-that-the-slave-works-using-a-load-balancer" title="Direct link to heading">#</a></h3><p>One simple way to test that the slave machines work is simply using a load
balancer. You can deregister the master from the load balancer, and then only
the slave machines will receive requests. You can check that this is true
by watching the logs of <code>nginx</code>, <code>agora-elections</code>, or <code>authapi</code> in both
machines, and checking that only the slave is receiving requests with the
following commands:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">supervisorctl </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> -f agora-elections</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">supervisorctl </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> -f authapi</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> -F /var/log/nginx/access.log</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note that you can configure the load balancer to establish a health check to
the PATH <code>/admin-api/authapi/api/auth-event/1/</code>. This should return a HTTP
status 200 through TLS and port 443, when authapi is running.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="checking-database-replication"></a>Checking database replication<a class="hash-link" href="#checking-database-replication" title="Direct link to heading">#</a></h4><p>You can also test that the database replication is working both <code>prod-s2</code> and
<code>prod-s1</code> that the following command has this kind of output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> -u postgres /usr/lib/postgresql/12/bin/repmgr -f /etc/repmgr/repmgr.conf cluster show</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> ID </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> Name        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> Role    </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> Status    </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> Upstream    </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> Location </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> Priority </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> Timeline </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> Connection string</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">----+-------------+---------+-----------+-------------+----------+----------+----------+--------------------------------------------</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> prod-s1     </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> primary </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> * running </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">             </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> default  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">host</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">prod-s1 </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">user</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">repmgr </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">dbname</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">repmgr</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> prod-s2     </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> standby </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">   running </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> prod-s1     </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> default  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">host</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">prod-s2 </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">user</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">repmgr </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">dbname</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">repmgr</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Execution in either of them should result in the same results. Additionally, you
can verify that any change in the database in <code>prod-s1</code> is reflected in
<code>prod-s2</code>. For example, if you have created elections using the UI or otherwise,
they should appear in both machines:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> -u postgres psql agora_elections -tAc </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;select id,state from election;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">5001</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">registered</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">5002</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">registered</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">5003</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">registered</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">5005</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">results_ok</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="checking-certificates-and-public-keys-synchronization"></a>Checking certificates and public keys synchronization<a class="hash-link" href="#checking-certificates-and-public-keys-synchronization" title="Direct link to heading">#</a></h4><p>If you list the files inside the datastore and the server certificate in
both <code>prod-s1</code> and <code>prod-s2</code>, it should list the same files:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1:/root/prod-s1/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> -u agoraelections </span><span class="token function" style="color:rgb(130, 170, 255)">find</span><span class="token plain"> /home/agoraelections/datastore/ -type f </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">xargs</span><span class="token plain"> md5sum</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05b76ec89dd7a32b76427d389a5778c1  /home/agoraelections/datastore/public/2/pks</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@prod-s1:/root/prod-s1/ $ </span><span class="token function" style="color:rgb(130, 170, 255)">find</span><span class="token plain"> /srv/certs/selfsigned/ -type f </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">xargs</span><span class="token plain"> md5sum</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">d811c3e92162ade25f21f1d782f32c6e  /srv/certs/selfsigned/calist</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">54a67dfe2a9fde364a833135d9bfdd3b  /srv/certs/selfsigned/key-nopass.pem</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">a9bf327511b67100c096aebed5b46c94  /srv/certs/selfsigned/cert.pem</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="checking-memcached-configuration"></a>Checking memcached configuration<a class="hash-link" href="#checking-memcached-configuration" title="Direct link to heading">#</a></h4><p>Memcached is a service used by <code>agora-elections</code> to cache data to avoid hitting
the database and improve performance. Only master&#x27;s memcached instance is used.
The <code>agora-elections</code> process in the slave machines will connect to it.</p><p>You can review the following:</p><p><strong>1. Check that the memcached service is running in the master (<code>prod-s1</code>)</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">service</span><span class="token plain"> memcached status</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">● memcached.service - memcached daemon</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     Loaded: loaded </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">/lib/systemd/system/memcached.service</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> vendor preset: enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     Active: active </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> since Thu </span><span class="token number" style="color:rgb(247, 140, 108)">2021</span><span class="token plain">-12-02 08:32:13 CET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> 3h 37min ago</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       Docs: man:memcached</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   Main PID: </span><span class="token number" style="color:rgb(247, 140, 108)">219127</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">memcached</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      Tasks: </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">limit: </span><span class="token number" style="color:rgb(247, 140, 108)">4693</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     Memory: </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">.5M</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     CGroup: /system.slice/memcached.service</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">             └─219127 /usr/bin/memcached -m </span><span class="token number" style="color:rgb(247, 140, 108)">64</span><span class="token plain"> -p </span><span class="token number" style="color:rgb(247, 140, 108)">11211</span><span class="token plain"> -u memcache -l </span><span class="token number" style="color:rgb(247, 140, 108)">127.0</span><span class="token plain">.0.1,172.31.43.83 -P /var/run/memcached/memcached.pid</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Dec 02 08:32:13 test-500-s1 systemd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">: Started memcached daemon.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note that the memcached process is listening on (UDP) port 11211 for both local
(127.0.0.1) and the private IP of the master machine (in this example,
172.31.43.83).</p><p>Remember that as described in the
<a href="#network-firewall--dns">Network, firewall &amp; DNS</a> section, UDP Port 11211 needs
to be open in the private network between the servers for memcached to work
properly.</p><p><strong>2. Check the statistics of the memcached within the master</strong></p><p>You can see some statistics of the master machine with memcache-top:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> clone https://github.com/eculver/memcache-top.git</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">perl memcache-top/memcache-top --instances</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">127.0</span><span class="token plain">.0.1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memcache-top v0.7       </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">default port: </span><span class="token number" style="color:rgb(247, 140, 108)">11211</span><span class="token plain">, color: on, refresh: </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> seconds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token environment constant" style="color:rgb(130, 170, 255)">INSTANCE</span><span class="token plain">                USAGE   HIT %   CONN    TIME    ITEMS   EVICT/s READ/s  WRITE/s</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">127.0</span><span class="token plain">.0.1:11211         </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">%    </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">%    </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">.3ms           </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">639</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AVERAGE:                </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">%    </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">%    </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">.3ms           </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">639</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TOTAL:          0B/     </span><span class="token number" style="color:rgb(247, 140, 108)">64</span><span class="token plain">.0MB          </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">.3ms           </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">639</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ctrl-c to quit.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>3. Check conectivity to master from a slave machine</strong></p><p>You can use again memcached-top to see if you can connect to the master
(<code>prod-s1</code>) from the slave machine (<code>prod-s2</code>), executing memcached-top in
the slave (<code>prod-s2</code>):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> clone https://github.com/eculver/memcache-top.git</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">perl memcache-top/memcache-top --instances</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">prod-s1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memcache-top v0.7       </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">default port: </span><span class="token number" style="color:rgb(247, 140, 108)">11211</span><span class="token plain">, color: on, refresh: </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> seconds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token environment constant" style="color:rgb(130, 170, 255)">INSTANCE</span><span class="token plain">                USAGE   HIT %   CONN    TIME    ITEMS   EVICT/s READ/s  WRITE/s</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">prod-s1:11211           </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">%    </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">%    </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">.3ms           </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">639</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AVERAGE:                </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">%    </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">%    </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">.3ms           </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">639</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TOTAL:          0B/     </span><span class="token number" style="color:rgb(247, 140, 108)">64</span><span class="token plain">.0MB          </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">.3ms           </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">639</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ctrl-c to quit.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If the connection to <code>prod-s1</code> had not been working, it would have shown
something like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">perl memcache-top/memcache-top --instances</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">prod-s1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memcache-top v0.7       </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">default port: </span><span class="token number" style="color:rgb(247, 140, 108)">11211</span><span class="token plain">, color: on, refresh: </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> seconds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token environment constant" style="color:rgb(130, 170, 255)">INSTANCE</span><span class="token plain">                USAGE   HIT %   CONN    TIME    ITEMS   EVICT/s READ/s  WRITE/s</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">test-500-s3:11211 is DOWN.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AVERAGE:                </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">%    </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">%            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">.0ms           </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TOTAL:          0B/     0B                      </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">.0ms           </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>4. Check the correct configuration of <code>agora-elections</code> in both master and slaves</strong></p><p>You can check that memcached is being properly configured in `agora-elections``
in both the master:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> memcache /home/agoraelections/agora-elections/conf/application.local.conf -C </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># memcached</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">ehcacheplugin</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">disabled</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memcached.host</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;127.0.0.1:11211&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">logger.memcached</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">WARN</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And within the slave:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> memcache /home/agoraelections/agora-elections/conf/application.local.conf -C </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># memcached</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">ehcacheplugin</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">disabled</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memcached.host</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;prod-s1:11211&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">logger.memcached</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">WARN</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="promoting-a-slave-to-be-master"></a>Promoting a slave to be master<a class="hash-link" href="#promoting-a-slave-to-be-master" title="Direct link to heading">#</a></h3><p>In this example we would be:</p><ol><li>Creating an election in <code>prod-s1</code>.</li><li>Casting some votes.</li><li>Promoting the <code>prod-s2</code> to master.</li><li>Continue casting votes.</li><li>Sucessfully tally the election.</li></ol><p>We&#x27;ll be asuming you know how to perform steps 1 and 2.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="step-3-promoting-the-prod-s2-to-master"></a>Step 3: Promoting the <code>prod-s2</code> to master<a class="hash-link" href="#step-3-promoting-the-prod-s2-to-master" title="Direct link to heading">#</a></h4><p>You should first ensure that now <code>prod-s1</code> is either demoted to be configured
as a slave or is not receiving any more requests from the client. Otherwise, you
could end up with two different servers acting as Database Masters, and thus
with some votes arriving to one server and not in the other. You don&#x27;t want
that.</p><p>Thus, if you are using a load balancer, configure it to prevent <code>prod-s1</code> from
receiving votes. Otherwise, you could point voters to <code>prod-s2</code> reassigning the
public IP of the server <code>prod-s1</code> to <code>prod-s2</code>, or something along the lines.</p><p>Afterwards, to promote <code>prod-s2</code> to be the master, change set to <code>true</code> the
<code>config.yml</code> config variable <code>config.load_balancing.is_master</code>, and then execute
ansible for <code>prod-s2</code> with the <code>playbook.agora.yml</code> playbook:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">time</span><span class="token plain"> ansible-playbook -i inventory playbook.yml</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">date</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="step-4-continue-casting-votes"></a>Step 4: Continue casting votes<a class="hash-link" href="#step-4-continue-casting-votes" title="Direct link to heading">#</a></h4><p>Once step 3 is done, you can continue casting the votes normally if needed.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="step-5-run-the-tally"></a>Step 5: Run the tally<a class="hash-link" href="#step-5-run-the-tally" title="Direct link to heading">#</a></h4><p>To be able to receive successfully the tally, prod-s2 needs to &quot;impersonate&quot;
prod-s1 as the director election authority. This can be done by:</p><ol><li>removing the prod-s1 eopeer package:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">agora@prod-a1:~ $ </span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> eopeers --remove prod-s1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="2"><li>adding an alias to /etc/hosts in <code>prod-a1</code> config.yml variable <strong>config.hosts</strong>,
setting it to something like:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">hostname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> prod</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">s1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 192.168.50.14 </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># this should be the ip of the new master</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="3"><li>re-executing ansible in <code>prod-a1</code>:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">time</span><span class="token plain"> ansible-playbook -i inventory playbook.yml</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">date</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="troubleshooting"></a>Troubleshooting<a class="hash-link" href="#troubleshooting" title="Direct link to heading">#</a></h2><p>For troubleshooting please read the
<a href="/admin-manual/docs/deployment/troubleshooting">Deployment Troubleshooting</a>.</p></div><footer class="docusaurus-mt-lg"><div class="row"><div class="col"><a href="https://github.com/agoravoting/admin-manual/edit/master/docs/deployment/guide.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/admin-manual/docs/deployment/troubleshooting"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Deployment Troubleshooting »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#requirements" class="table-of-contents__link">Requirements</a></li><li><a href="#ops-environment" class="table-of-contents__link">Ops environment</a><ul><li><a href="#configuring-access-to-each-vm-inside-the-ops-machine" class="table-of-contents__link">Configuring access to each VM inside the ops machine</a></li><li><a href="#configuring-ops-hosts" class="table-of-contents__link">Configuring ops hosts</a></li><li><a href="#collaborate-sharing-with-tmuxinator" class="table-of-contents__link">Collaborate sharing with tmuxinator</a></li><li><a href="#creating-the-mux-project" class="table-of-contents__link">Creating the mux project</a></li></ul></li><li><a href="#for-each-machine" class="table-of-contents__link">For each machine</a><ul><li><a href="#machine-provisioning" class="table-of-contents__link">Machine provisioning</a></li><li><a href="#machine-configuration" class="table-of-contents__link">Machine configuration</a></li><li><a href="#network-firewall--dns" class="table-of-contents__link">Network, firewall &amp; DNS</a></li><li><a href="#backups" class="table-of-contents__link">Backups</a></li><li><a href="#non-root-permissions-optional" class="table-of-contents__link">Non-root permissions (optional)</a></li><li><a href="#timezones-details" class="table-of-contents__link">Timezones details</a></li><li><a href="#install-and-configure-deployment-dependencies" class="table-of-contents__link">Install and configure deployment dependencies</a></li></ul></li><li><a href="#web-servers-master--slave-deployment" class="table-of-contents__link">Web servers master &amp; slave deployment</a><ul><li><a href="#configure-the-slave" class="table-of-contents__link">Configure the slave</a></li></ul></li><li><a href="#deployment-of-authorities" class="table-of-contents__link">Deployment of authorities</a><ul><li><a href="#connecting-authorities" class="table-of-contents__link">Connecting authorities</a></li><li><a href="#test-the-connection-between-the-authorities" class="table-of-contents__link">Test the connection between the authorities</a></li><li><a href="#connecting-web-servers-with-authorities" class="table-of-contents__link">Connecting web servers with authorities</a></li></ul></li><li><a href="#create-a-test-election" class="table-of-contents__link">Create a test election</a></li><li><a href="#high-availability-and-load-balancing-halb" class="table-of-contents__link">High availability and load balancing (HA/LB)</a><ul><li><a href="#checking-the-cluster" class="table-of-contents__link">Checking the cluster</a></li><li><a href="#checking-that-the-slave-works-using-a-load-balancer" class="table-of-contents__link">Checking that the slave works using a Load Balancer</a></li><li><a href="#promoting-a-slave-to-be-master" class="table-of-contents__link">Promoting a slave to be master</a></li></ul></li><li><a href="#troubleshooting" class="table-of-contents__link">Troubleshooting</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/admin-manual/docs/deployment/guide">Deployment</a></li><li class="footer__item"><a class="footer__link-item" href="/admin-manual/docs/translation/guide">Translation</a></li><li class="footer__item"><a class="footer__link-item" href="/admin-manual/docs/testing/bulk">Election Testing</a></li><li class="footer__item"><a class="footer__link-item" href="/admin-manual/docs/advanced-elections/introduction">Advanced Topics</a></li><li class="footer__item"><a class="footer__link-item" href="/admin-manual/docs/contribute/guide">Contribute</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/agoravoting" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discord.gg/BSqF8Cbr" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/nvotes_com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://nvotes.com/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li><li class="footer__item"><a href="https://github.com/agoravoting/admin-manual" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 nVotes</div></div></div></footer></div>
<script src="/admin-manual/assets/js/runtime~main.73bf6be1.js"></script>
<script src="/admin-manual/assets/js/main.c8b16299.js"></script>
</body>
</html>