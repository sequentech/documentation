(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{137:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/smartlink-sequence-diagram-85c2b9e56e94f58c116393a4b6844818.png"},138:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/step-4-e92e7d6430244f8249f2867442e5eb9e.png"},139:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/step-5-065de389dfe8cbd2d7f0b7e340eb1bd7.png"},140:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/step-6-fa5b6e77c3d03fb4da7a48f97a8b5bcf.png"},141:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/step-7-dd78d62ad1758962424334eb515fd142.png"},142:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/new-election-b99caebb1b45cc8ac207046014e33dfd.png"},143:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/admin-auth-8d8812046ce9c55c5294628d84629e58.png"},144:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/extra-fields-286b5b49008ca5efe2e8ae94c504afaa.png"},145:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/files/example-smart-link-3da6b02b0965e5e52053babf61a0717e.yaml"},146:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/adding-voters-4c97ee11519e55e6550f89e5f9e9e058.png"},147:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/public-election-site-c69d9232bc2e4daa54cd71d61e2494dc.png"},148:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/public-election-site-error-auth-35c8762817be0d05a74544511b0de278.png"},73:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return r})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return h}));var a=n(3),i=n(7),o=(n(0),n(92)),r={id:"smart-link-auth",title:"SmartLink Authentication",sidebar_label:"SmartLink Authentication",slug:"/integrations/smart-link-auth"},s={unversionedId:"integrations/smart-link-auth",id:"integrations/smart-link-auth",isDocsHomePage:!1,title:"SmartLink Authentication",description:"Introduction",source:"@site/docs/integrations/smart-link-auth.md",slug:"/integrations/smart-link-auth",permalink:"/admin-manual/docs/integrations/smart-link-auth",editUrl:"https://github.com/agoravoting/admin-manual/edit/master/docs/integrations/smart-link-auth.md",version:"current",sidebar_label:"SmartLink Authentication",sidebar:"docsSidebar",previous:{title:"Write-ins",permalink:"/admin-manual/docs/advanced-elections/write-ins"},next:{title:"Contribution Guide",permalink:"/admin-manual/docs/contribute/guide"}},c=[{value:"Introduction",id:"introduction",children:[]},{value:"What it is",id:"what-it-is",children:[]},{value:"How it works",id:"how-it-works",children:[{value:"<code>auth-token</code> overview",id:"auth-token-overview",children:[]}]},{value:"Integration",id:"integration",children:[{value:"Step 4: Showing the vote action",id:"step-4-showing-the-vote-action",children:[]},{value:"Step 5: Requesting the SmartLink",id:"step-5-requesting-the-smartlink",children:[]},{value:"Step 6: Generating and returning the SmartLink",id:"step-6-generating-and-returning-the-smartlink",children:[]},{value:"Step 7: Loading the SmartLink",id:"step-7-loading-the-smartlink",children:[]}]},{value:"Example: How to use smart-link auth",id:"example-how-to-use-smart-link-auth",children:[{value:"Election creation",id:"election-creation",children:[]},{value:"JSON configuration",id:"json-configuration",children:[]},{value:"Shared Secret configuration",id:"shared-secret-configuration",children:[]},{value:"Census",id:"census",children:[]},{value:"Parent and Children elections",id:"parent-and-children-elections",children:[]},{value:"Public site",id:"public-site",children:[]},{value:"Authentication testing",id:"authentication-testing",children:[]}]}],l={toc:c};function h(e){var t=e.components,r=Object(i.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},l,r,{components:t,mdxType:"MDXLayout"}),Object(o.b)("h2",{id:"introduction"},"Introduction"),Object(o.b)("p",null,"In this document we will explain everything you need to know about SmartLink\nauthentication mechanism: what it is, what it provides, how it works, and how\nto use it."),Object(o.b)("h2",{id:"what-it-is"},"What it is"),Object(o.b)("p",null,"SmartLink is a Single sign-on (SSO) authentication mechanism provided by the\nnVotes platform that uses a Keyed ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/HMAC"}),"HMAC"),"\nauthentication token. It allows you to send voters that\nare already authenticated  in your own platform or website to a voting link\nfor a specific election without forcing them to authenticate again in nVotes\nPlatform. It is a secure and simple way to implement Single sign-on."),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"Other Single sign-one methods")),Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"nVotes Platform also supports the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/file-formats/election-creation-json#census-auth_method"}),"OpenID Connect authentication method"),"\nto implement Single sign-on."))),Object(o.b)("h2",{id:"how-it-works"},"How it works"),Object(o.b)("p",null,"SmartLink is a native authentication method in nVotes platform. Voters will be\nauthenticated through a link that includes a secure authentication token (the\n",Object(o.b)("inlineCode",{parentName:"p"},"auth-token"),"), but  ",Object(o.b)("strong",{parentName:"p"},"authorization is done by nVotes platform"),". This\nmeans that the administrator need to upload the census in nVotes platform."),Object(o.b)("p",null,"The authentication flow compromises the following steps:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"Voters are asumed to start by being already authenticated in your website or\nplatform (the ",Object(o.b)("inlineCode",{parentName:"li"},"external application"),")."),Object(o.b)("li",{parentName:"ol"},"In the external application, voters launch the action to vote, and this\nredirects them to a SmartLink in nVotes Platform."),Object(o.b)("li",{parentName:"ol"},"The nVotes platform loads the SmartLink, performing authentication and\nauthorization and automatically redirecting to the voting booth when\nauthentication and authorization succeed.")),Object(o.b)("p",null,"A more detailed sequence diagram of the steps involved is shown below:"),Object(o.b)("div",{style:{textAlign:"center"}},Object(o.b)("p",null,Object(o.b)("img",{alt:"SmartLink Sequence Diagram",src:n(137).default}))),Object(o.b)("p",null,"As can be seen in the sequence diagram, the single interaction of the voter\nclicking in the action to Vote inside the External Application triggers a\nseries of events that ends up loading nVotes User Interface (UI) with an\ninternal authentication token. "),Object(o.b)("p",null,"After the final step shown in the sequence diagram (number 10), nVotes UI will\nautomatically load the voting booth and the voter's will be vote correctly\nauthenticated when cast."),Object(o.b)("h3",{id:"auth-token-overview"},Object(o.b)("inlineCode",{parentName:"h3"},"auth-token")," overview"),Object(o.b)("p",null,"The auth-token is generated in the external application, and verified by nVotes\nplatform. It is a cryptographically secure to transmit information between the\nexternal application and nVotes plataform."),Object(o.b)("p",null,"The following data is securely transmitted through the auth-token:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"user-id"),": A unique identifier string of the voter. This is the way nVotes\nplatform matches the user with the previously census loaded in the election."),Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"election-id"),": The identifier of the election in which the voter will be\nauthenticated in and in which he is eligible to participate."),Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"timestamp"),": Timestamp in which the token was generated. It allows the toke\nto expire.")),Object(o.b)("p",null,"There are some other related data fields, but we will delve into the details\nlater. "),Object(o.b)("p",null,"All this data is signed by the usage of a keyed hash-based message\nauthentication code (also called a keyed\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/HMAC"}),"HMAC"),"). An HMAC is a cryptographic\nmechanism that uses the fact that\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/Hash_function"}),"hash functions")," are\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/One-way_function"}),"one-way functions")," to use the\nhashing as a secure signature mechanism. A one-way function is a function that\nis easy to calculate in one direction, but very difficult or impossible to\ncalculate in the opposite direction. Hash functions are one-way functions."),Object(o.b)("p",null,"The external application will generate the message to be signed, then hash it\nusing the HMAC mechanism and the HMAC signature. The auth-token is\ncomposed by both the message and the HMAC code (or HMAC for short)."),Object(o.b)("p",null,"We use a keyed HMAC, which means that the hashing is of two things together:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"The message"),Object(o.b)("li",{parentName:"ol"},"A shared secret, that only the external application and nVotes platform know.")),Object(o.b)("p",null,"Because hash functions are one-way functions, the resulting HMAC can only\nbe calculated having access to the hashed data. The HMAC serves as a\nsignature because part of the hashed data (the shared secret) is secret. nVotes\nplatform can authenticate that the message was generated by an authorized\nparty by receiving the authentication token, and calculating the HMAC by\nusing the message included in the auth-token with the shared secret. If\nthe resulting HMAC matches the hash included in the auth-token, then nVotes\nplatform has successfully verified that the hash was generated by someone with\naccess to the shared secret, which means the external application in our case."),Object(o.b)("p",null,"The auth-token cannot be generated in the web-client of the\nexternal application, because that would mean that the shared secret would be\naccessible by the voter. The shared secret cannot be accessible by anyone else\nbut nVotes Platform and the external application backend servers. The shared\nsecret needs to  remain in the backend servers and not leave them. Of course,\nin nVotes platform the same principle applies, and only the backend servers can\nand do verify the auth-token."),Object(o.b)("h2",{id:"integration"},"Integration"),Object(o.b)("p",null,"The steps 4 to 7 as shown in the sequence diagram from the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"#how-it-works"}),"how it works section"),", need to be implemented in the external\napplication."),Object(o.b)("h3",{id:"step-4-showing-the-vote-action"},"Step 4: Showing the vote action"),Object(o.b)("div",{style:{textAlign:"center"}},Object(o.b)("p",null,Object(o.b)("img",{alt:"SmartLink Sequence Diagram: Step 4",src:n(138).default}))),Object(o.b)("p",null,"At this step we start assuming the voter is correctly authenticated in the\nexternal application and the external application is being run in the voter's\ndevice."),Object(o.b)("p",null,"The voter should be presented an action to be able to request to vote. This can\nbe a button or any other user interface representation. This action to vote MUST\nonly be enabled during the voting period in which this specific voter can\nparticipate, and the action must be related to a specific election."),Object(o.b)("p",null,"The nVotes platform assumes that the vote action will not be enabled once\nthe voting is finished. If for some reason the action is activated when the\nelection is not within the voting period, the authentication will fail and the\nvoter will be redirected to the election public page."),Object(o.b)("p",null,"In nVotes platform voters can in some cases vote multiple times, depending on the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/file-formats/election-creation-json##election-num_successful_logins_allowed"}),"election configuration"),". In any case, only the last vote cast by each voter will be counted. This is\ntherefore not a security breach, but on the contrary a typical security measure\nin secure electronic voting systems to mitigate coercion, and we comment on it\nbecause it implies that in the cases where vote changing is allowed, the access\nto the vote action should not disappear when the voter has voted. The reason is\nsimple: the voter can change his/her vote by casting another vote during the\nvoting period."),Object(o.b)("p",null,"According to the above, it is not strictly necessary for the application to\nmonitor whether the voter has already clicked on the vote button, or whether\nthe voter has clicked on the vote button but has not finished voting, or whether\nthe voter has clicked on the vote button and has effectively cast the vote\ncorrectly. The external application can simply show the vote button whenever an\nelection is in progress."),Object(o.b)("p",null,"In some cases, it is required that each voter can cast only one vote. As\nmentioned earlier, this is configurable in the election configuration. If this\nis done and the voter has already voted, then when the voter accesses a second\ntime to the SmartLink it will show a generic authentication error message saying\nthat the authentication did not succeed, mentioning multiple possible reasons\nwhy this error might happen."),Object(o.b)("p",null,"Authentication error messages are explicitly vague for security reasons. Showing\ndifferent error messages might unintentionally reveal information to an\nattacker."),Object(o.b)("h3",{id:"step-5-requesting-the-smartlink"},"Step 5: Requesting the SmartLink"),Object(o.b)("div",{style:{textAlign:"center"}},Object(o.b)("p",null,Object(o.b)("img",{alt:"SmartLink Sequence Diagram: Step 5",src:n(139).default}))),Object(o.b)("p",null,"When the voter clicks the vote action button, the external application should\nrequest to the external application backend servers the SmartLink. The SmartLink\nshould:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"Not be pre-generated or preloaded, as the SmartLink contains the auth-token\nand the auth-token has a limited lifetime for security reasons related to it\nbeing a bearer token."),Object(o.b)("li",{parentName:"ol"},"Should be generated in the backend and not in javascript in the web browser\nof the voting device, because the generation of the SmartLink requires access\nto the shared secret and the shared secret should not leave the backend servers.")),Object(o.b)("p",null,"The connection betweeen the external application user interface and the\nexternal application backend servers should be encrypted end-to-end, typically\nusing TLS, so that the bearer token cannot be sniffed by any third-party\nattacker."),Object(o.b)("p",null,"Of course, this request must be properly authenticated using whichever\nauthentication procedures that the external application uses internally."),Object(o.b)("h3",{id:"step-6-generating-and-returning-the-smartlink"},"Step 6: Generating and returning the SmartLink"),Object(o.b)("div",{style:{textAlign:"center"}},Object(o.b)("p",null,Object(o.b)("img",{alt:"SmartLink Sequence Diagram: Step 6",src:n(140).default}))),Object(o.b)("p",null,"The external application backend servers receive the SmartLink generation\nrequest and need to safely process it, generate the SmartLink and return the\nSmartLink to the external application user interface."),Object(o.b)("p",null,"First, the request needs to be validated and authenticated. Failing to correctly\nverify the authentication of the request to generate the SmartLink would\ngenerate a security vulnerability, because an attacker could receive a\nSmartLink to vote in place of other voters. It's the responsability of the\nexternal application to setup proper request authentication verification\nmechanisms."),Object(o.b)("p",null,"Once the request is authenticated, then the application needs to\nverify that voter is eligible to vote in the specific requested election and\nthat this specific election is in the voting period. In nVotes platform,\nelections are identifed by the ",Object(o.b)("inlineCode",{parentName:"p"},"election-id"),", a positive integer that\nidentifies the election."),Object(o.b)("h4",{id:"the-smartlink-format"},"The SmartLink format"),Object(o.b)("p",null,"The SmartLink is a string with the following pattern:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{}),"https://example.com/election/<election-id>/public/login?auth-token=<auth-token>\n")),Object(o.b)("p",null,"For example, if nVotes platform is deployed in the domain\n",Object(o.b)("inlineCode",{parentName:"p"},"vote.university.com"),", and the election id is ",Object(o.b)("inlineCode",{parentName:"p"},"150017"),", the SmartLink for a\nvoter whose ",Object(o.b)("inlineCode",{parentName:"p"},"user-id")," is ",Object(o.b)("inlineCode",{parentName:"p"},"example@nvotes.com")," would look similar to the\nfollowing:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{}),"https://vote.university.com/election/150017/public/login?auth-token=\nkhmac:///sha-256;8e0b1b553c29046cf5988a0e24d6ce276f6d14d27918da5d219\nb634970c3f706/example@nvotes.com:AuthEvent:150017:vote:1620805691\n")),Object(o.b)("p",null,"For the same election, the only part that varies in each smart link is the\n",Object(o.b)("inlineCode",{parentName:"p"},"auth-token"),"."),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"Auth-token and URI encoding")),Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"The auth-token is provided as an URI parameter and thus needs to be encoded\nproperly. Usually, if you use characters like ",Object(o.b)("inlineCode",{parentName:"p"},"a-zA-Z@:0-9")," it's not going to\npose a problem. You don't need to actually process the auth-token as it will be\nautomatically done by the web browser. It will just work out."),Object(o.b)("p",{parentName:"div"},"But if you are going to use some other characters, even a simple ",Object(o.b)("inlineCode",{parentName:"p"},"+")," or ",Object(o.b)("inlineCode",{parentName:"p"},"%"),"\ncharacter in the shared secret or in the user-id, you need to URI encode the\nauth-token. We ",Object(o.b)("strong",{parentName:"p"},"strongly recommend")," always applying URI encoding of the\nauth-token just in case to avoid encoding issues in the  future."),Object(o.b)("p",{parentName:"div"},"A way to do this is using the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent"}),"encodeURIComponent()"),"\nJavascript function. As the code that will redirect or load the SmartLink runs\nin the web browser, this function should be available for you to use. "),Object(o.b)("p",{parentName:"div"},"For manual testing purposes, you can use the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.urlencoder.org/"}),"urlencoder.org")," website."))),Object(o.b)("h4",{id:"the-auth-token-format"},"The ",Object(o.b)("inlineCode",{parentName:"h4"},"auth-token")," format"),Object(o.b)("p",null,"Please refer to the ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"#auth-token-overview"}),"auth-token overview")," section in which\nwe explain how the auth-token works."),Object(o.b)("p",null,"The auth-token is a string that has the following format:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{}),"khmac:///sha-256;<code>/<message>\n")),Object(o.b)("p",null,"The code is generated by applying the HMAC function to the message plus the\nshared secret. The code is generated with the standard HMAC procedure with the\nSHA-256 hashing function, further defined in the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://web.archive.org/web/20201208050119/http://csrc.nist.gov/publications/fips/fips198-1/FIPS-198-1_final.pdf"}),"U.S. Federal Information Processing Standards Publication 198"),". "),Object(o.b)("p",null,"We provide two examples of how to generate the auth-token:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=bb69ae8415e95815ee8d1d722873c79b"}),"Auth-token generation in Rust language")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://play.golang.org/p/lp44mNTxfeu"}),"Auth-token generation in Go language"))),Object(o.b)("p",null,"In other programming languages it is possible to generate the HMAC in a\nsimilar way, as it is a standard security mechanism."),Object(o.b)("h4",{id:"the-auth-token-message-format"},"The ",Object(o.b)("inlineCode",{parentName:"h4"},"auth-token")," message format"),Object(o.b)("p",null,"The message is the string to be signed using the HMAC procedure. It has the\nfollowing format:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{}),"<user-id: String>:AuthEvent:<election-id: Int>:vote:<timestamp: Int>\n")),Object(o.b)("p",null,"For example, a valid message could be:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{}),"example@nvotes.com:AuthEvent:150017:vote:1620927640\n")),Object(o.b)("p",null,"As can be seen there are three pieces of information within the message:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"user-id")," It is a text string used by nVotes Platform as an identifier of\nthe voter. There are several important considerations with regards to the\nuser-id:",Object(o.b)("ol",{parentName:"li"},Object(o.b)("li",{parentName:"ol"},"The user-id must always be the same for each voter on each election. That\nis, if a voter votes twice in the same election, the user-id must be the same.\nThe user-id is the way nVotes Platform will find if the voter previously\nvoted, and in that way nVotes Platform decides whether to save the vote as a\nnew vote or overwrite the voter's previous vote."),Object(o.b)("li",{parentName:"ol"},"The user-id is the lookup field by which nVotes will try to find the voter\nin the census to perform authorization. If the user-id is not included in the\ncensus of the election, authorization will fail. If the user-id is from\nanother voter, the voter would be voting in place of this other voter. Thus,\nit's critical to correctly set this field."),Object(o.b)("li",{parentName:"ol"},"To avoid transmitting any additional information about the voter beyond a\nunique identifier, the voter id can be a hash of a unique internal identifier\nof the voter, known only to the external application. In this manner this\ninformation does not have to transcend outside the external application. For\nexample, the affiliate number in an assocation or internal database unique\nuser id can be used."),Object(o.b)("li",{parentName:"ol"},"We recommend using SHA-256 as a hashing function, and avoiding SHA-1 or MD5\nfor security reasons."),Object(o.b)("li",{parentName:"ol"},"We recommend that you do not directly hash the voter's id, but rather hash\nthe id plus a salt. The salt must be another secret key, which is only known\nby the external application servers, and thus protects against attacks that\nreveal the voter's id."),Object(o.b)("li",{parentName:"ol"},"It is recommended that the salt varies for each election. That way in each\nelection the user-id for the same voter will be different, thus reducing the\ninformation revealed through the user-id to nVotes platform strictly to the\nminimum necessary. Therefore, it is recommended that you include the\nelection-id in the salt to be hashed."))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"election-id")," The unique identifier of the election. It is necessary to\ninclude it so that the message, which is trusted by nVotes platform because it\nis cryptographically signed, associates the user-id to a specific election, and\nthus the same message cannot be used for different elections in the event that\nthere are two or more elections running at once. The election-id will be\nprovided by nVotes Platform for each election, and it will be a positive\ninteger."),Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"timestamp"),' It is the date on which the message was generated, in\n"UNIX timestamp" format, that is, an integer with the number of seconds since\nJanuary 1, 1970 (',Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://en.wikipedia.org/wiki/Unix_time"}),"more information"),").\nThe message includes the timestamp as a way to calculate an expiration date\nfor said authenticated message, as we have explained previously. The auth-token\nneeds to expire because it is a bearer token, meaning that anyone with access\nto it will be able to use it. For this reason its lifetime needs to be\nlimited. It's important to verify that the clocks of both backend servers (that\nof nVotes Platform and that of the external application) are synchronized, so\nthat the message expiration calculation is possible.")),Object(o.b)("h3",{id:"step-7-loading-the-smartlink"},"Step 7: Loading the SmartLink"),Object(o.b)("div",{style:{textAlign:"center"}},Object(o.b)("p",null,Object(o.b)("img",{alt:"SmartLink Sequence Diagram: Step 7",src:n(141).default}))),Object(o.b)("p",null,"Once the external application receives the SmartLink, the next step is very\nsimple: load the SmartLink URL. This can be performed using one of the following\nmethods: "),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Load the URL in a web browser widget if the external application is a native\nmobile or desktop application and you don't want to move the voter to a web\nbrowser."),Object(o.b)("li",{parentName:"ul"},"Load the URL in a new web browser window if the external application is a\nnative mobile or desktop application and you don't mind moving the voter to a\nweb browser."),Object(o.b)("li",{parentName:"ul"},"Load the URL in a new tab if the external application is a website and you\ndon't want the voter to close the external application tab."),Object(o.b)("li",{parentName:"ul"},"Load the URL changing the current ",Object(o.b)("inlineCode",{parentName:"li"},"window.location.href")," if the external\napplication is a website and you don't mind closing the external application\nwebsite.")),Object(o.b)("p",null,"Note that currently you ",Object(o.b)("strong",{parentName:"p"},"cannot")," load the SmartLink in an iframe, as it would\ninterfere with other integration methods and would not work."),Object(o.b)("h2",{id:"example-how-to-use-smart-link-auth"},"Example: How to use smart-link auth"),Object(o.b)("h3",{id:"election-creation"},"Election creation"),Object(o.b)("p",null,"We will create an election with a smart-link and authenticate with it. The\neasiest way to do it is using the Administrative Interface. First click in\nthe ",Object(o.b)("inlineCode",{parentName:"p"},"New Election")," sidebar action, which will lead to a page similar to this:"),Object(o.b)("p",null,Object(o.b)("img",{alt:"New Election",src:n(142).default})),Object(o.b)("p",null,"Then in the sidebar click in the ",Object(o.b)("inlineCode",{parentName:"p"},"Authentication")," section, and inside it choose\nthe ",Object(o.b)("inlineCode",{parentName:"p"},"Smart Link")," authentication method:"),Object(o.b)("p",null,Object(o.b)("img",{alt:"Smart Link Authentication",src:n(143).default})),Object(o.b)("p",null,"Note that the list of authentication methods shown in the list depends on which\nones you have enabled to be shown in the ",Object(o.b)("inlineCode",{parentName:"p"},"config.agora_gui.shown_auth_methods"),"\nsetting in the",Object(o.b)("inlineCode",{parentName:"p"},"config.yml")," deployment configuration file. If ",Object(o.b)("inlineCode",{parentName:"p"},"Smart Link")," is not\nshown here, please enable it in the ",Object(o.b)("inlineCode",{parentName:"p"},"config.yml")," and redeploy."),Object(o.b)("p",null,"After doing that, if you click in the ",Object(o.b)("inlineCode",{parentName:"p"},"Census Configuration")," section you will\nfind that an mandatory extra field called ",Object(o.b)("inlineCode",{parentName:"p"},"user_id")," has been added:"),Object(o.b)("p",null,Object(o.b)("img",{alt:"Admin extra fields",src:n(144).default})),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"user_id")," field is used during authorization. It's matched against the\ncensus as explained earlier in this document."),Object(o.b)("h3",{id:"json-configuration"},"JSON configuration"),Object(o.b)("p",null,"Other than that, we can leave the rest of the election configuration by default\nand create the election as is. In the ",Object(o.b)("inlineCode",{parentName:"p"},"Create Election")," sidebar section, if you\nclick in the pencil button you can see and edit the election configuration json.\nIt will be similar to this ",Object(o.b)("a",{target:"_blank",href:n(145).default},"example-smart-link.json"),".\nYou can follow the same patterns in there to create the election using JSON\nyourself."),Object(o.b)("p",null,"In particular, you will see that the authentication method has been set to\n",Object(o.b)("inlineCode",{parentName:"p"},"smart-link")," and it contains the ",Object(o.b)("inlineCode",{parentName:"p"},"user_id")," extra field:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json",metastring:'title="example-smart-link.json fragment" {7-18}',title:'"example-smart-link.json','fragment"':!0,"{7-18}":!0}),'... rest of the configution ....\n\n    "census": {\n      "has_ballot_boxes": false,\n      "voters": [],\n      "census": "close",\n      "auth_method": "smart-link",\n      "extra_fields": [\n        {\n          "must": true,\n          "name": "user_id",\n          "type": "text",\n          "required": true,\n          "min": 1,\n          "max": 255,\n          "required_on_authentication": true\n        }\n      ],\n\n... rest of the configution ....\n')),Object(o.b)("p",null,"You could add more extra fields if you wanted. For example you could add an\nextra field that has the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/file-formats/election-creation-json#extra-field-private"}),"private property"),"\nset to ",Object(o.b)("inlineCode",{parentName:"p"},"true"),". This would allow to have some voter related data in the\ncensus that is only visible to election administrators."),Object(o.b)("h3",{id:"shared-secret-configuration"},"Shared Secret configuration"),Object(o.b)("p",null,"The shared secret that is used in authapi to verify that the auth-token comes\nfrom a trusted source can be configured for authapi in two different manners:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"The election specific shared-secret, set in the election JSON configuration\nfile in the ",Object(o.b)("inlineCode",{parentName:"li"},"census.config.shared_secret")," key. It's not required, but if\nprovided it will be used."),Object(o.b)("li",{parentName:"ol"},"As a shared-secret used for the whole deployment. This is configured in the\n",Object(o.b)("inlineCode",{parentName:"li"},"config.agora_elections.shared_secret")," setting within the ",Object(o.b)("inlineCode",{parentName:"li"},"config.yml"),"\ndeployment configuration file. It's used by default.")),Object(o.b)("p",null,"Below you can see a fragment of the election JSON configuration file with\nthe election-specific shared secret set to ",Object(o.b)("inlineCode",{parentName:"p"},"the cake is in the oven"),"."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json",metastring:'title="example-smart-link.json fragment" {4}',title:'"example-smart-link.json','fragment"':!0,"{4}":!0}),'    ... rest of the configution ....\n    "census": {\n      "config": {\n        "shared_secret": "the cake is in the oven",\n        "allow_user_resend": false,\n        "authentication-action": {\n          "mode": "vote",\n          "mode-config": {\n            "url": ""\n          }\n        },\n        "registration-action": {\n          "mode": "vote",\n          "mode-config": null\n        }\n      }\n      ... rest of the configution ....\n')),Object(o.b)("h3",{id:"census"},"Census"),Object(o.b)("p",null,"Once you create the election, you will be able to access to the dashboard of the\nelection as usual. You can add manually voter(s) like we do in the picture\nbelow. As usual, you could have done it also in the previous step in the\njson configuration or through the admin user interface during election creation."),Object(o.b)("p",null,Object(o.b)("img",{alt:"Adding voters",src:n(146).default})),Object(o.b)("h3",{id:"parent-and-children-elections"},"Parent and Children elections"),Object(o.b)("p",null,"Adding the voters to the census is required. The external application does the\nauthentication, but nVotes systems will be in charge of authorization. Also,\nif you want to use\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/advanced-elections/parent-and-children-elections/"}),"parent-children elections"),",\nyou can do it. It works like explained there. You can just the\n",Object(o.b)("inlineCode",{parentName:"p"},"smart-link")," authentication, and it will work as expected: each voter in the\nparent election will be able to vote only in the children elections assigned\nto the voter."),Object(o.b)("h3",{id:"public-site"},"Public site"),Object(o.b)("p",null,"Through the election dashboard you can access to the ",Object(o.b)("inlineCode",{parentName:"p"},"Election public site"),".\nThis goes to a link typically with the format\n",Object(o.b)("inlineCode",{parentName:"p"},"https://example.com/election/<election-id>/public/home")," that shows a page\nsimilar to:"),Object(o.b)("p",null,Object(o.b)("img",{alt:"Public election site",src:n(147).default})),Object(o.b)("p",null,"Even if the election is within the voting period, the voting site does not show\na link to the authentication page. Because of how this authentication method\nworks, the voter is expected to do the authentication through the external\napplication and not through our public election site."),Object(o.b)("p",null,"The voter authentication page still exists, though. It's URL typically follows\nthe pattern ",Object(o.b)("inlineCode",{parentName:"p"},"https://example.com/election/<election-id>/public/login"),". As usual, if the\nvoting period is not open, that page will redirecto the home of the public site\n(ending in ",Object(o.b)("inlineCode",{parentName:"p"},"/public/home"),"). If the election is during the voting period, a voter\ndirectly accessing to this website will be shown a generic error:"),Object(o.b)("p",null,Object(o.b)("img",{alt:"Public election site error auth",src:n(148).default})),Object(o.b)("h3",{id:"authentication-testing"},"Authentication testing"),Object(o.b)("p",null,"Once we have added voter(s), you need to\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"#integration"}),"integrate the external application")," to test the whole\nauthentication process."),Object(o.b)("p",null,"You can also test the authentication method manually to ensure it works without\nusing the external application. To do so, you need to craft a valid\nSmartLink:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{}),"https://example.com/election/<election-id>/public/login?auth-token=<auth-token>\n")),Object(o.b)("p",null,"To generate the ",Object(o.b)("inlineCode",{parentName:"p"},"auth-token"),", we can use the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=bb69ae8415e95815ee8d1d722873c79b"}),"Auth-token generation in Rust language")," that we mentioned in the integration\nguide."),Object(o.b)("p",null,"You can just change the default data provided in that code using the appropiate\n",Object(o.b)("inlineCode",{parentName:"p"},"user_id"),", ",Object(o.b)("inlineCode",{parentName:"p"},"election-id")," and unix timestamp. If you don't know what is the\ncurrent timestamp, you can run the command ",Object(o.b)("inlineCode",{parentName:"p"},"date +%s")," in your server (or any\nother machine with the same timezone) to obtain it."),Object(o.b)("p",null,"Inserting the auth-token into the SmartLink should directly authenticate you\nand show the voting booth allowing you to cast a valid vote."))}h.isMDXComponent=!0},92:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return p}));var a=n(0),i=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=i.a.createContext({}),h=function(e){var t=i.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=h(e.components);return i.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},b=i.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,r=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),d=h(n),b=a,p=d["".concat(r,".").concat(b)]||d[b]||u[b]||o;return n?i.a.createElement(p,s(s({ref:t},l),{},{components:n})):i.a.createElement(p,s({ref:t},l))}));function p(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=b;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var l=2;l<o;l++)r[l]=n[l];return i.a.createElement.apply(null,r)}return i.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"}}]);