"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[311],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),c=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},p=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),p=c(n),m=r,h=p["".concat(s,".").concat(m)]||p[m]||d[m]||a;return n?o.createElement(h,i(i({ref:t},u),{},{components:n})):o.createElement(h,i({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<a;c++)i[c]=n[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}p.displayName="MDXCreateElement"},461:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var o=n(3117),r=(n(7294),n(3905));const a={sidebar_position:9,title:"Cron Tasks Guide"},i=void 0,l={unversionedId:"general/guides/cron-tasks/cron-tasks",id:"general/guides/cron-tasks/cron-tasks",title:"Cron Tasks Guide",description:"Using config.yml from deployment-tool, you can configure the system to schedule jobs using Cron. This can be useful to perform election tasks such as:",source:"@site/docs/general/guides/cron-tasks/cron-tasks.md",sourceDirName:"general/guides/cron-tasks",slug:"/general/guides/cron-tasks/",permalink:"/documentation/docs/general/guides/cron-tasks/",draft:!1,editUrl:"https://github.com/sequentech/documentation/edit/master/docs/general/guides/cron-tasks/cron-tasks.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{sidebar_position:9,title:"Cron Tasks Guide"},sidebar:"generalSidebar",previous:{title:"Segmented Mixing Guide",permalink:"/documentation/docs/general/guides/segmented-mixing/"},next:{title:"Scheduled Events Guide",permalink:"/documentation/docs/general/guides/scheduled-events/"}},s={},c=[],u={toc:c};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Using ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yml")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"deployment-tool"),", you can configure the system to schedule jobs using ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Cron"},"Cron"),". This can be useful to perform election tasks such as:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Starting/Stopping an election at a certain time."),(0,r.kt)("li",{parentName:"ul"},"Tallying an election at a certain time."),(0,r.kt)("li",{parentName:"ul"},"For elections with progressive tallies, updating the result with certain frequency.")),(0,r.kt)("h1",{id:"schedule-starting-an-election"},"Schedule starting an election"),(0,r.kt)("p",null,"In this example we schedule a server to start an election (with id ",(0,r.kt)("inlineCode",{parentName:"p"},"4"),") at a specific time by\nusing the ",(0,r.kt)("inlineCode",{parentName:"p"},"admin.py")," tool from the ",(0,r.kt)("inlineCode",{parentName:"p"},"ballot-box")," project. Edit the ",(0,r.kt)("inlineCode",{parentName:"p"},"config.crontab_tasks")," variable\nin the ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yml")," file of the web server with this configuration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"  crontab_tasks:\n  - name: start-election\n    # job is the command to be run. The command should not contain line\n    # breaks.\n    job: 'bash -c \"source /home/ballotbox/tenv/bin/activate; /home/ballotbox/ballot-box/admin/admin.py auth_start 4 >> /home/ballotbox/crontab.log 2>&1\"'\n    # The specific user whose crontab should be modified.\n    user: 'ballotbox'\n    # minute when the job should run ( 0-59, *, */2, etc )\n    minute: 0\n    # hour when the job should run ( 0-23, *, */2, etc )\n    hour: 15\n    # Day of the month the job should run ( 1-31, *, */2, etc )\n    day: '17'\n    # day of the week that the job should run ( 0-6 for Sunday-Saturday, *, etc )\n    weekday: '*'\n    # Month of the year the job should run ( 1-12, *, */2, etc )\n    month: '9'\n")),(0,r.kt)("p",null,"Ensure that the line ",(0,r.kt)("inlineCode",{parentName:"p"},"- import_tasks: crontab.yml")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"playbook.yml")," file is uncommented.\nThen deploy the configuration with ansible:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    date; time unbuffer ansible-playbook -i inventory playbook.yml -vvvv 2>&1 | tee log.txt; date\n")),(0,r.kt)("h1",{id:"tally-an-election-every-5-minutes"},"Tally an election every 5 minutes"),(0,r.kt)("p",null,"In this example the web server will be tallying an election every 5 minutes,\nto update the results as new votes are cast."),(0,r.kt)("p",null,"First you need to enable progressive tallying. This means you'll be able to perform multiple tallies\nfor the same election. Every time a new tally is performed, the data from the previous tally will be\nerased. Progressive tallying is required for certain types of elections, but be aware of its security\nimplications."),(0,r.kt)("p",null,"The first step is to set the ",(0,r.kt)("inlineCode",{parentName:"p"},"config.enable_multiple_tallies")," variable in the ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yml")," file\nto ",(0,r.kt)("inlineCode",{parentName:"p"},"True")," and deploy this configuration in the master web server and all authorities."),(0,r.kt)("p",null,"Then you also need to add a cron task to the ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yml")," file in the master web server. In this case\nthe election id is ",(0,r.kt)("inlineCode",{parentName:"p"},"34562754")," and it has two children elections ",(0,r.kt)("inlineCode",{parentName:"p"},"34562755,34562756"),". The task will run\nevery 5 minutes and you can read the log at ",(0,r.kt)("inlineCode",{parentName:"p"},"/home/ballotbox/crontab.log"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"  crontab_tasks:\n  - name: progressive-tally\n    # job is the command to be run. The command should not contain line\n    # breaks.\n    job: 'bash -c \"source /home/ballotbox/tenv/bin/activate; /home/ballotbox/ballot-box/admin/admin.py --children-election-ids 34562755,34562756 --force-tally force-all --mode active trigger_tally 34562754 >> /home/ballotbox/crontab.log 2>&1\"'\n    # The specific user whose crontab should be modified.\n    user: 'ballotbox'\n    # minute when the job should run ( 0-59, *, */2, etc )\n    minute: '*/5' \n    # hour when the job should run ( 0-23, *, */2, etc )\n    hour: '*'\n    # Day of the month the job should run ( 1-31, *, */2, etc )\n    day: '*'\n    # day of the week that the job should run ( 0-6 for Sunday-Saturday, *, etc )\n    weekday: '*'\n    # Month of the year the job should run ( 1-12, *, */2, etc )\n    month: '*'\n")))}d.isMDXComponent=!0}}]);